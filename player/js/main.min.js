function stopMovie(){tick=0,current_frame=0,pauseMovie(0)}function pauseMovie(e){animFrame(storyboard.frames[0]),isPlaying=!1,clearInterval(interval);var r=e/1e3/(total_duration-1)*canvas.width-10;0>r&&(r=0),document.getElementById("cursor").style.left=r+"px",document.getElementById("bar-active").style.width=r+"px",document.getElementById("but_play").innerHTML="play_arrow"}function startLoading(e){var r=JSON.parse(e);user=r.user,showUser(user),storyboard=r.storyboard,showStoryboardInfo(storyboard),0==storyboard.info.length&&showMessage("Storyboard não existe")}function showStoryboardInfo(e){console.log(e),resizeCanvas(e.info.frame_format),document.getElementById("title").innerHTML=e.info.title,document.getElementById("last_update").innerHTML=e.info.last_update,document.getElementById("description").innerHTML=e.info.description,e.info.cover_img=new Image,e.info.cover_img.src="http://"+e.info.cover,document.getElementById("duration_play").innerHTML=parseTime(e.info.duration),total_duration=e.info.duration,fps=1e3/e.info.FPS,acc_time=[];for(var r=0;r<e.frames.length;r++)0==acc_time.length?acc_time.push(e.frames[r].duration):acc_time.push(acc_time[r-1]+e.frames[r].duration);var a="<p>Duração: "+parseTime(total_duration)+"</p>";a+="<p>FPS: "+e.info.FPS+"</p>",a+="<p>Quadros: "+e.frames.length+"</p>",a+="<p>Formato: "+(1==e.info.frame_format?"4:3":"16:9")+"</p>",document.getElementById("info").innerHTML=a,setGestureInfo(),loadImages()}function setGestureInfo(){for(var e=0;e<storyboard.frames.length;e++)for(var r=0;r<storyboard.frames[e].layers.length;r++)if(1==storyboard.frames[e].layers[r].isGesture)for(var a=0;a<storyboard.frames[e].layers[r].gestures.length;a++){var t=storyboard.frames[e].layers[r].gestures[a].params;if("Translation"==storyboard.frames[e].layers[r].gestures[a].name){for(var s=[],o=0;o<t.length;o++){var n=t[o].value,i=n.substr(2,n.length-3).split(",");s.push(new Point(parseInt(i[0]),parseInt(i[1])))}var l=s[0].x,c=s[0].x,d=s[1].x,m=s[1].y,u=new Point(l,c),y=new Point(d,m);null!=storyboard.frames[e].layers[r].gestures[a].actionLayer&&(storyboard.frames[e].layers[r].gestures[a].step=storyboard.frames[e].layers[r].gestures[a].step*canvas.width/storyboard.frames[e].layers[storyboard.frames[e].layers[r].gestures[a].actionLayer].img.width),storyboard.frames[e].layers[r].gestures[a].rect=new Rect(d>l?u:y,d>l?y:u);var f=(storyboard.frames[e].layers[r].gestures[a].rect.p2.x-storyboard.frames[e].layers[r].gestures[a].rect.p1.x)/((storyboard.frames[e].duration+2)*storyboard.info.FPS);console.log("RECT",storyboard.frames[e].layers[r].gestures[a].rect),console.log("STEP",f),storyboard.frames[e].layers[r].gestures[a].step=f,storyboard.frames[e].layers[r].gestures[a].position=storyboard.frames[e].layers[r].gestures[a].rect.p1,console.log(storyboard.frames[e].layers[r].gestures[a].position)}else if("Rotation"==storyboard.frames[e].layers[r].gestures[a].name){for(var g=[],o=0;o<t.length;o++){var n=t[o].value;i=parseInt(n.substr(3,n.length-3)),isNaN(i)||g.push(i)}storyboard.frames[e].layers[r].gestures[a].angles=g;var f=Math.abs(g[1]-g[0])/((storyboard.frames[e].duration-1)*fps);storyboard.frames[e].layers[r].gestures[a].step=f,storyboard.frames[e].layers[r].gestures[a].angle=0+g[0]}else if("Cam"==storyboard.frames[e].layers[r].gestures[a].name){storyboard.frames[e].layers[r].gestures[a].frameObjects=[];for(var o=0;o<t.length;o++){var n=t[o].value.split(",");n[0]=n[0].substr(3,n[0].length-1),n[n.length-1]=n[n.length-1].substr(0,n[n.length-1].length-1),storyboard.frames[e].layers[r].gestures[a].frameObjects.push({x:parseInt(n[0]),y:parseInt(n[1]),width:parseInt(n[2]),height:parseInt(n[3])})}var h=storyboard.frames[e].layers[r].gestures[a].frameObjects;storyboard.frames[e].layers[r].gestures[a].clipping={x:h[0].x,y:h[0].y,width:h[0].width,height:h[0].height},storyboard.frames[e].layers[r].gestures[a].step={x:Math.abs(h[1].x-h[0].x)/(storyboard.frames[e].duration*fps),y:Math.abs(h[1].y-h[0].y)/(storyboard.frames[e].duration*fps),width:Math.abs(h[1].width-h[0].width)/(storyboard.frames[e].duration*fps),height:Math.abs(h[1].height-h[0].height)/(storyboard.frames[e].duration*fps)}}storyboard.frames[e].layers[r].gestures[a].actionLayer=searchActionLayer(storyboard.frames[e].layers,r)}}function searchActionLayer(e,r){for(var a=-1,t=r-1;t>=0;t--)if(0==e[t].isGesture){a=t;break}return a}function loadImages(){contImg=0;for(var e=0;e<storyboard.frames.length;e++)for(var r=0;r<storyboard.frames[e].layers.length;r++)storyboard.frames[e].layers[r].img=new Image,storyboard.frames[e].layers[r].img.onload=function(){contImg++,contImg==storyboard.info.totalImages&&startMovie()},storyboard.frames[e].layers[r].img.src="http://"+storyboard.frames[e].layers[r].image}function startMovie(){showPreloader(!1),document.getElementById("but_play").addEventListener("click",playMovie),document.getElementById("prev_frame").addEventListener("click",prevFrame),document.getElementById("next_frame").addEventListener("click",nextFrame),document.getElementById("cursor").addEventListener("mousedown",onCursorDown);for(var e=0;e<storyboard.frames.length;e++)for(var r=0;r<storyboard.frames[e].layers.length;r++)if(storyboard.frames[e].layers[r].offset=new Point(canvas.width,canvas.height),storyboard.frames[e].layers[r].size=new Point(0,0),0==storyboard.frames[e].layers[r].isGesture){ctx.drawImage(storyboard.frames[e].layers[r].img,0,0,canvas.width,canvas.height);for(var a=0;a<canvas.width;a++)for(var t=0;t<canvas.height;t++){var s=ctx.getImageData(a,t,1,1).data;0!=s[3]&&(a<storyboard.frames[e].layers[r].offset.x&&(storyboard.frames[e].layers[r].offset.x=a),t<storyboard.frames[e].layers[r].offset.y&&(storyboard.frames[e].layers[r].offset.y=t),a>storyboard.frames[e].layers[r].size.x&&(storyboard.frames[e].layers[r].size.x=a),t>storyboard.frames[e].layers[r].size.y&&(storyboard.frames[e].layers[r].size.y=t))}storyboard.frames[e].layers[r].size.x-=storyboard.frames[e].layers[r].offset.x,storyboard.frames[e].layers[r].size.y-=storyboard.frames[e].layers[r].offset.y,ctx.clearRect(0,0,canvas.width,canvas.height)}showFrame(storyboard.frames[0])}function onCursorDown(){(isPlaying=!0)&&(pauseMovie(tick),showFrame(storyboard.frames[look4current(Math.floor(tick/1e3)+2)]),window.addEventListener("mousemove",onCursorMove),window.addEventListener("mouseup",onCursorUp))}function prevFrame(){pauseMovie(),current_frame>0&&current_frame--,showFrame(storyboard.frames[current_frame]);var e=0;current_frame>0&&(e=acc_time[current_frame-1]),showBarTime(e)}function nextFrame(){pauseMovie(),current_frame<storyboard.frames.length-1&&current_frame++,showFrame(storyboard.frames[current_frame]);var e=0;current_frame>0&&(e=acc_time[current_frame-1]),showBarTime(e)}function showBarTime(e){var r=canvas.width*e/total_duration;document.getElementById("cursor").style.left=r+"px",document.getElementById("bar-active").style.width=r+"px",document.getElementById("duration_play").innerHTML=parseTime(e)}function onCursorMove(e){if(e.clientX>.1*window.innerWidth&&e.clientX<.9*window.innerWidth-10){var r=e.clientX-.1*window.innerWidth;document.getElementById("cursor").style.left=r+"px",document.getElementById("bar-active").style.width=r+"px";var a=Math.floor((total_duration+1)*(e.clientX-.1*window.innerWidth)/canvas.width);showFrame(storyboard.frames[look4current(a)]),document.getElementById("duration_play").innerHTML=parseTime(a)}}function onCursorUp(e){window.removeEventListener("mousemove",onCursorMove)}function look4current(e){var r=0;if(e>=total_duration)r=acc_time.length-1;else for(var a=0;a<acc_time.length&&e>acc_time[a];a++)r++;return r}function playMovie(){document.getElementById("duration_play").innerHTML==parseTime(total_duration)&&stopMovie(),showFrame(storyboard.frames[current_frame]);var e=document.getElementById("cursor").offsetLeft-canvas.width*(1-canvasWScale/2);tick=(e+10)/canvas.width*(total_duration-1)*1e3,isPlaying?(clearInterval(interval),document.getElementById("but_play").innerHTML="play_arrow"):(interval=setInterval(startInterval,1e3/fps),document.getElementById("but_play").innerHTML="pause"),isPlaying=!isPlaying}function startInterval(){for(tick+=1e3/fps;Math.floor(tick/1e3)+1<1;)tick+=1e3/fps;document.getElementById("duration_play").innerHTML=parseTime(Math.floor(tick/1e3)+1);var e=tick/1e3/(total_duration-1)*canvas.width-10;e>canvas.width-10&&(e=canvas.width-10),0>e&&(e=0),document.getElementById("cursor").style.left=e+"px",document.getElementById("bar-active").style.width=e+"px",Math.floor(tick/1e3)+2>acc_time[current_frame]&&(current_frame<storyboard.frames.length-1&&current_frame++,Math.floor(tick/1e3)+2<=total_duration&&showFrame(storyboard.frames[current_frame])),animFrame(storyboard.frames[current_frame]),Math.floor(tick/1e3)==total_duration-1&&(clearInterval(interval),tick=0,current_frame=0,isPlaying=!1,document.getElementById("but_play").innerHTML="play_arrow")}function animFrame(e){ctx.clearRect(0,0,canvas.width,canvas.height);for(var r=!1,a=0;a<e.layers.length;a++)e.layers[a].isOnScreen=!1;for(var a=0;a<e.layers.length;a++)for(var t=0;t<e.layers[a].gestures.length;t++)e.layers[e.layers[a].gestures[t].actionLayer].isOnScreen=!0;for(var a=0;a<e.layers.length;a++)if(1==e.layers[a].isGesture){r=!0;for(var t=0;t<e.layers[a].gestures.length;t++)if("Translation"==e.layers[a].gestures[t].name){var s=e.layers[a].gestures[t].position.x;(e.layers[a].gestures[t].position.x<=e.layers[a].gestures[t].rect.p1.x||e.layers[a].gestures[t].position.y<=e.layers[a].gestures[t].rect.p1.y)&&(s=e.layers[a].gestures[t].rect.p1.x),s+=e.layers[a].gestures[t].step;var o=e.layers[a].gestures[t].rect.getY(s);(s>e.layers[a].gestures[t].rect.p2.x||o>e.layers[a].gestures[t].rect.p2.y)&&(s=e.layers[a].gestures[t].rect.p2.x,o=e.layers[a].gestures[t].rect.p2.y),e.layers[a].gestures[t].position=new Point(s,o);var n=e.layers[e.layers[a].gestures[t].actionLayer].offset;showImage("translation",e.layers[e.layers[a].gestures[t].actionLayer].img,s-n.x,o-n.y)}else if("Rotation"==e.layers[a].gestures[t].name){e.layers[a].gestures[t].angle+=e.layers[a].gestures[t].step;var n=e.layers[e.layers[a].gestures[t].actionLayer].offset,i=e.layers[e.layers[a].gestures[t].actionLayer].size;showImage("rotation",e.layers[e.layers[a].gestures[t].actionLayer].img,n.x,n.y,e.layers[a].gestures[t].angle,i.x,i.y)}else if("Cam"==e.layers[a].gestures[t].name){e.layers[a].gestures[t].step;e.layers[a].gestures[t].clipping.x+=e.layers[a].gestures[t].step.x,e.layers[a].gestures[t].clipping.y+=e.layers[a].gestures[t].step.y,e.layers[a].gestures[t].clipping.width+=e.layers[a].gestures[t].step.width,e.layers[a].gestures[t].clipping.height+=e.layers[a].gestures[t].step.height,showImage("cam",e.layers[e.layers[a].gestures[t].actionLayer].img,0,0,null,0,0,e.layers[a].gestures[t].clipping)}}else e.layers[a].isOnScreen||showImage(null,e.layers[a].img,0,0);if(!r)for(var a=0;a<e.layers.length;a++)0==e.layers[a].isGesture&&showImage(null,e.layers[a].img,0,0)}function showFrame(e){ctx.clearRect(0,0,canvas.width,canvas.height);for(var r=0;r<e.layers.length;r++)if((0==e.layers[r].isGesture||1==e.layers[r].isGesture&&showGesture)&&showImage(null,e.layers[r].img),1==e.layers[r].isGesture)for(var a=0;a<e.layers[r].gestures.length;a++)if("Translation"==e.layers[r].gestures[a].name&&(e.layers[r].gestures[a].position=e.layers[r].gestures[a].rect.p1.clone(),animFrame(e)),"Rotation"==e.layers[r].gestures[a].name&&(e.layers[r].gestures[a].angle=e.layers[r].gestures[a].angles[0],animFrame(e)),"Cam"==e.layers[r].gestures[a].name){var t=e.layers[r].gestures[a].frameObjects;e.layers[r].gestures[a].clipping={x:t[0].x,y:t[0].y,width:t[0].width,height:t[0].height}}}function showPreloader(e){document.getElementById("preloader").style.display=e?"block":"none"}function showUser(e){document.getElementById("author-name").innerHTML=e.username,document.getElementById("author-email").innerHTML=e.email,document.getElementById("useravatar").src="http://"+e.avatar}function showMessage(e){console.log(e)}function showImage(e,r,a,t,s,o,n,i){null==a&&(a=0),null==t&&(t=0),null==s&&(s=0),null==e&&(e=""),a>canvas.width&&(a=canvas.width),t>canvas.height&&(t=canvas.height),canvas.style.backgroundColor="#fff","rotation"==e?(ctx.save(),ctx.translate(a+o/2,t+n/2),ctx.rotate(s*Math.PI/180),ctx.translate(-(a+o/2),-(t+n/2)),ctx.drawImage(r,0,0,canvas.width,canvas.height),ctx.restore()):"cam"==e?(a=i.x*canvas.width/r.width,t=i.y*canvas.height/r.height,o=i.width*canvas.width/r.width,n=i.height*canvas.height/r.height,ctx.drawImage(r,a,t,o,n,0,0,canvas.width,canvas.height)):"translation"==e?(a=a*canvas.width/r.width,t=t*canvas.height/r.height,console.log(a,t),ctx.drawImage(r,a,t,canvas.width,canvas.height)):ctx.drawImage(r,a,t,canvas.width,canvas.height)}function resizeCanvas(e){canvas.width=window.innerWidth*canvasWScale,1==e?canvas.height=3*canvas.width/4:2==e&&(canvas.height=9*canvas.width/16)}function parseTime(e){var r=0,a=0;return e>60&&(r=Math.floor(e/60),e-=60*r),r>60&&(a=Math.floor(r/60),r-=60*a),10>e&&(e="0"+e),10>r&&(r="0"+r),a>0&&10>a&&(a="0"+a),a>0?a+":"+r+":"+e:r+":"+e}function gup(e,r){r||(r=location.href),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a="[\\?&]"+e+"=([^&#]*)",t=new RegExp(a),s=t.exec(r);return null==s?null:s[1]}var xobj=null,user=null,storyboard=null,canvas,ctx,showGesture=!1,fps=12,canvasWScale=.5,total_duration,interval,acc_time;window.onload=function(){document.getElementById("cb_gesture").onchange=function(){showGesture=document.getElementById("cb_gesture").checked},canvas=document.getElementById("canvas");var e=document.getElementById("player");canvas.width=window.innerWidth*canvasWScale,e.style.width=100*canvasWScale+"%",ctx=canvas.getContext("2d"),resizeCanvas(1),showPreloader(!0);var r=gup("id",window.location),a=gup("user",window.location),t="http://localhost/slap/restful/index.php/storyboard/"+a+"/"+r;xobj=new XMLHttpRequest,xobj.overrideMimeType("application/json"),xobj.open("GET",t,!0),xobj.onreadystatechange=function(){4==xobj.readyState&&("200"==xobj.status?startLoading(xobj.responseText):showMessage("problema na conexão"))},xobj.send(null)},window.onresize=function(){resizeCanvas(storyboard.info.frame_format),stopMovie()};var contImg=0,tick=0,isPlaying=!1,current_frame=0;