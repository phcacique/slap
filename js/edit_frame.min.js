function init(){document.addEventListener("keydown",onkeydown),document.addEventListener("keyup",onkeyup),tools.push(document.getElementById("tool0")),tools.push(document.getElementById("tool1")),tools.push(document.getElementById("tool2")),tools.push(document.getElementById("tool3"));for(var e=0;4>e;e++)tools[e].addEventListener("mouseover",ontoolsover),tools[e].addEventListener("mouseout",ontoolsout),tools[e].addEventListener("click",ontoolsclick,!1);tools[selectedTool].src="img/tool"+selectedTool+".png",document.getElementById("bsize").value=10,croquis.getDOMElement().addEventListener("mousemove",moveMouse),document.getElementById("addLayer").addEventListener("click",addLayer),startDraw()}function ontoolsclick(e){var t=e.target.id.split("tool")[1];("img/ic_gesture_green_24px.svg"!=document.getElementById("ges"+selectedLayer).getAttribute("src")||0==t||3==t)&&(selectedTool=t,selectTool(t),selectToolImage(t))}function selectTool(e){croquis.lockHistory(),setBrush(e),selectedTool=e,0==e?croquis.setPaintingKnockout(!0):croquis.setPaintingKnockout(!1),croquis.unlockHistory(),document.getElementById("bsize").value=isNaN(brushes[selectedTool].getSize())?10:brushes[selectedTool].getSize(),document.getElementById("balpha").value=alphas[selectedTool];var t=document.getElementById("brushImg");t.src=brushes[selectedTool].getImage().src,changeSize(),document.getElementById("fgcolor").style.opacity=alphas[selectedTool]}function ontoolsover(e){var t=e.target.id.split("tool")[1];selectToolImage(t),tools[selectedTool].src="img/tool"+selectedTool+".png"}function ontoolsout(e){var t=e.target.id.split("tool")[1];t!=selectedTool&&(tools[t].src="img/tool"+t+"b.png"),tools[selectedTool].src="img/tool"+selectedTool+".png"}function selectToolImage(e){for(var t=0;4>t;t++)tools[t].src="img/tool"+t+"b.png";tools[e].src="img/tool"+e+".png"}function onkeydown(e){e.ctrlKey&&(ctrl=!0),90==e.keyCode&&ctrl?croquis.undo():89==e.keyCode&&ctrl?croquis.redo():e.shiftKey&&187==e.keyCode?(bsize+=10,changeSize(bsize)):e.shiftKey&&189==e.keyCode&&bsize>10&&(bsize-=10,changeSize(bsize))}function onkeyup(e){e.ctrlKey&&(ctrl=!1)}function startDraw(e){frame_format=e,ch=.8*window.innerHeight,cw=1==frame_format?4*ch/3:16*ch/9;var t=document.getElementById("mainEdit").offsetWidth-(document.getElementById("toolsdiv").offsetWidth+20);if(cw>t&&(cw=t,ch=1==frame_format?3*cw/4:9*cw/16),canvasArea=document.getElementById("canvasArea"),canvasArea.innerHTML="",offX=canvasArea.offsetLeft,offY=canvasArea.offsetTop,croquis.lockHistory(),croquis.setCanvasSize(cw,ch),0==layerArray.length)addLayer(null),null!=temp_img&&croquis.fillLayerImage(temp_img,cw,ch),selectedLayer=0;else{for(var a=0;a<layerArray.length;a++)addLayer(null),croquis.selectLayer(a),document.getElementById("nameLayer"+a).value=layerArray[a].name,croquis.fillLayerImage(imgBase+layerArray[a].image,cw,ch),document.getElementById("clop"+a).src=1==layerArray[a].visibility?"img/ic_visibility_black_24px.svg":"img/ic_visibility_off_black_24px.svg",croquis.setLayerVisible(1==layerArray[a].visibility?!0:!1),document.getElementById("ges"+a).src=1==layerArray[a].gesture?"img/ic_gesture_green_24px.svg":"img/ic_gesture_black_24px.svg",layerNames[a]=layerArray[a].name;document.getElementById("nameLayer0").value=layerArray[0].name,selectedLayer=a-1,selectLayer(document.getElementById("layer"+selectedLayer))}croquis.selectLayer(0),croquis.unlockHistory(),setBrush(0),croquis.setToolStabilizeLevel(blevel),croquis.setToolStabilizeWeight(bweight),canvasArea.appendChild(croquis.getDOMElement()),croquis.getDOMElement().addEventListener("mousedown",function(e){var t=document.getElementById("picker");if(t.checked){var a=croquis.pickColor(e.clientX-offX,e.clientY-offY);a=rgbToHex(a.r,a.g,a.b);var r="#"+a;document.getElementById("fgcolor").jscolor=a,document.getElementById("fgcolor").value=a,document.getElementById("fgcolor").style.backgroundColor=r,changeColor(a),document.getElementById("picker").checked=!1,canvasArea.style.cursor="crosshair"}else croquis.down(e.clientX-offX,e.clientY-offY),croquis.getDOMElement().addEventListener("mousemove",onMouseMove),croquis.getDOMElement().addEventListener("mouseup",onMouseUp),isMoving||(isMoving=!0,timer1=setInterval(function(){activeTime++},1),null!=document.getElementById("ges"+selectedLayer)&&"img/ic_gesture_green_24px.svg"==document.getElementById("ges"+selectedLayer).getAttribute("src")&&(timer2=setInterval(function(){gestureTime++},1)))})}function rgbToHex(e,t,a){return((1<<24)+(e<<16)+(t<<8)+a).toString(16).slice(1)}function onMouseMove(e){croquis.move(e.clientX-offX,e.clientY-offY)}function onMouseUp(e){isMoving=!1,clearInterval(timer1),clearInterval(timer2),croquis.up(e.clientX-offX,e.clientY-offY),croquis.getDOMElement().removeEventListener("mousemove",onMouseMove),croquis.getDOMElement().removeEventListener("mouseup",onMouseUp)}function setBrush(e){croquis.setTool(brushes[e]),croquis.setPaintingOpacity(alphas[e])}function addBrush(e,t,a,r){var o=new Croquis.Brush;o.setSize(e),o.setColor(t),o.setSpacing(a),brushes.push(o);var s=new Image;s.src=r,s.onload=function(){o.setImage(s),croquis.setTool(brushes.length<2?brushes[0]:brushes[1]),changeSize(),contBrushes++,4==contBrushes&&init()},alphas.push(1)}function saveImage(){gestureLayersNumber=0,console.log("SAVE IMAGE"),showAlert();var e=document.getElementById("layers"),t=document.getElementById("sendImageForm");addInput(t,"numLayers",e.children.length,"hidden"),addInput(t,"id_frame",id_frame,"hidden"),addInput(t,"activeTime",activeTime,"hidden"),addInput(t,"gestureTime",gestureTime,"hidden"),addInput(t,"duration",document.getElementById("fdur").value,"hidden");var a=e.children.length;slapResults=[];for(var r=0;a>r;r++){var o=document.getElementById("nameLayer"+r).value,s="img/ic_gesture_green_24px.svg"==document.getElementById("ges"+r).getAttribute("src")?1:0,n="img/ic_visibility_black_24px.svg"==document.getElementById("clop"+r).getAttribute("src")?1:0;addInput(t,"layerName_"+r,o,"hidden"),addInput(t,"layerVisibility_"+r,n,"hidden"),addInput(t,"layerGesture_"+r,s,"hidden"),croquis.selectLayer(r),addInput(t,"layerFile_"+r,croquis.createLayerThumbnail().toDataURL("image/png"),"hidden"),s&&(gestureLayersNumber++,showAlert(MSG1+"<p>Gesture Layer #"+r+"</p>"),testSlap(r,croquis.getLayerCanvas(r),croquis.createLayerThumbnail().toDataURL("image/png"))),croquis.selectLayer(r),croquis.setLayerVisible(!0)}document.getElementById("file").value=croquis.createFlattenThumbnail().toDataURL("image/png"),document.getElementById("numFrame").value=parseInt(selectedFrame)+1,0==gestureLayersNumber&&submitForm()}function submitForm(e){document.forms.sendImageForm.submit(function(e){e.preventDefault()})}function addInput(e,t,a,r){var o=document.createElement("input");o.type=r,o.name=t,o.value=a,e.appendChild(o)}function changeColor(e){for(var t=0;t<brushes.length;t++)brushes[t].setColor("#"+e)}function changeSize(){var e=document.getElementById("bsize").value;bsize=parseInt(e),brushes[selectedTool].setSize(bsize);var t=brushes[selectedTool].getSize();document.getElementById("brushImg").width=t,document.getElementById("brushImg").height=t}function moveMouse(e){}function changeAlpha(){alphas[selectedTool]=document.getElementById("balpha").value,document.getElementById("fgcolor").style.opacity=alphas[selectedTool],croquis.setPaintingOpacity(alphas[selectedTool]),setBrush(selectedTool)}function allowDrop(e){e.preventDefault()}function drag(e){e1=e.target,("singleLayer"==e1.className||"singleLayer selected"==e1.className||"dicon"==e1.className)&&(isDragging=!0,"dicon"==e1.className&&(e1=e.target.parentElement.parentElement),t1=e1.parentElement,i1=Array.prototype.indexOf.call(t1.children,e1))}function drop(e){if(isDragging)if(e.preventDefault(),e2=e.target,t2=e2.parentElement,"dragname"==t2.className||"layerTools"==t2.className?(t2=e2.parentElement.parentElement.parentElement,e2=e.target.parentElement.parentElement):("singleLayer"==t2.className||"singleLayer selected"==t2.className)&&(t2=e2.parentElement.parentElemen,e2=e.target.parentElement),i2=Array.prototype.indexOf.call(t2.children,e2),i1>i2){t2.insertBefore(e1,t2.children[i2]);for(var t=i1;t>i2;t--)croquis.swapLayer(t,t-1)}else{t2.insertBefore(e1,t2.children[i2+1]);for(var t=i1;t<i2;t++)croquis.swapLayer(t,t+1)}isDragging=!1,className=""}function addLayer(e){for(var t=document.getElementById("layers"),a=[],r=0;r<t.children.length;r++)a.push(parseInt(t.children[r].getAttribute("id").split("layer")[1]));a.sort(function(e,t){return e-t});var o=0;t.children.length>0&&(o=a[a.length-1]+1),layerNames.push("Layer "+(o+1)),addLayerHTML(o),croquis.addLayer(),croquis.selectLayer(t.children.length-1);for(var r=0;r<t.children.length;r++)t.children[r].className="singleLayer",null!=document.getElementById("nameLayer"+r)&&(document.getElementById("nameLayer"+r).value=layerNames[r]);t.children[t.children.length-1].className="singleLayer selected"}function dropLayer(e,t){e.preventDefault();var a=document.getElementById("layers");if(a.children.length>1){var r=!1,o=document.getElementById(t.parentElement.parentElement.id);"singleLayer selected"==o.className&&(r=!0);var s=Array.prototype.indexOf.call(t.parentElement.parentElement.parentNode.children,t.parentElement.parentElement);croquis.removeLayer(s),o.parentElement.removeChild(o),r&&(a.children[0].className="singleLayer selected",selectedLayer=0),croquis.selectLayer(selectedLayer)}}function selectLayer(e){if(("singleLayer"==e.className||"singleLayer selected"==e.className)&&null!=e.parentNode){for(var t=Array.prototype.indexOf.call(e.parentNode.children,e),a=0;a<layers.children.length;a++)a!=t?layers.children[a].className="singleLayer":layers.children[a].className="singleLayer selected";null!=document.getElementById("ges"+selectedLayer)&&"img/ic_gesture_green_24px.svg"!=document.getElementById("ges"+selectedLayer).getAttribute("src")&&(oldColor=brushes[selectedTool].getColor(),oldAlpha=document.getElementById("balpha").value,oldSize=document.getElementById("bsize").value,oldTool=selectedTool),selectedLayer=t,croquis.selectLayer(selectedLayer),setGesture(document.getElementById("ges"+t),!0)}}function changeOpacity(e){var t=e.parentElement.parentElement;selectLayer(t);var a=parseInt(Array.prototype.indexOf.call(t.parentNode.children,t)),r=t.getAttribute("id").split("layer")[1];croquis.setLayerVisible(!croquis.getLayerVisible(a),a),document.getElementById("clop"+r).src=croquis.getLayerVisible(a)?"img/ic_visibility_black_24px.svg":"img/ic_visibility_off_black_24px.svg"}function addLayerHTML(e){var t=layers.innerHTML;layers.innerHTML=t+"<div class='singleLayer' ondrop='drop(event)' ondragover='allowDrop(event)' draggable='true' ondragstart='drag(event)' id='layer"+e+"' onclick='selectLayer(this)'><div class='dragname'><img src='img/ic_drag_handle_black_24px.svg' class='dicon' /><input id='nameLayer"+e+"' type='text' onchange='changeLayerName(this.value, "+e+")' value='"+layerNames[e]+"' class='lname' value='Layer "+(e+1)+"'/></div>                        <div class='layerTools'>                            <img src='img/ic_gesture_black_24px.svg' class='licon' onclick='setGesture(this,false)' id='ges"+e+"'/> <img src='img/ic_visibility_black_24px.svg' class='licon' onclick='changeOpacity(this)' id='clop"+e+"'/><img src='img/ic_delete_forever_black_24px.svg' class='licon' onclick='dropLayer(event,this)'/></div></div>"}function setGesture(e,t){if(null!=e){var n,a=e.parentElement.parentElement,o=(parseInt(Array.prototype.indexOf.call(a.parentNode.children,a)),a.getAttribute("id").split("layer")[1]),s=selectedLayer;n=t?"img/ic_gesture_black_24px.svg"==document.getElementById("ges"+o).getAttribute("src")?!0:!1:"img/ic_gesture_black_24px.svg"==document.getElementById("ges"+o).getAttribute("src")?!1:!0,isCanvasBlank(croquis.getLayerCanvas(o))||n?n?(document.getElementById("ges"+o).src="img/ic_gesture_black_24px.svg",setGestureTool(!1)):("img/ic_gesture_green_24px.svg"!=document.getElementById("ges"+s).getAttribute("src")&&(oldColor=brushes[selectedTool].getColor(),oldAlpha=document.getElementById("balpha").value,oldSize=document.getElementById("bsize").value,oldTool=selectedTool),document.getElementById("ges"+o).src="img/ic_gesture_green_24px.svg",setGestureTool(!0)):showAlert("Esta camada está vazia.","Tente novamente!","hideAlert()")}}function setGestureTool(e){var t=e?"429994":oldColor.split("#")[1],a="#"+t,r=e?1:oldAlpha,o=e?2:oldSize,s=e?3:oldTool;document.getElementById("fgcolor").jscolor=t,document.getElementById("fgcolor").value=t,document.getElementById("fgcolor").style.backgroundColor=a,changeColor(t),brushes[s].setColor(a),selectTool(s),selectToolImage(s),document.getElementById("bsize").value=o,changeSize(),document.getElementById("balpha").value=r,changeAlpha()}function changeLayerName(e,t){layerNames[t]=e}function showAlert(e,t,a,r){null==e&&(e=MSG1),document.getElementById("alertWaiting").style.visibility="visible";var o="<div><p>"+e+"</p>";null!=t&&null!=a&&null!=r?o+="<p>"+t+"</p><div><button class = 'cancelButton' onclick = '"+r+"'> NÃO </button> <button onclick = '"+a+"' > SIM </button> </div>":null!=t&&null!=a&&null==r&&(o+="<p>"+t+"</p><div><button class = 'cancelButton' onclick = '"+a+"'> TENTE NOVAMENTE </button>  </div>"),o+="</div>",document.getElementById("alertWaiting").innerHTML=o}function hideAlert(){drawBack(),document.getElementById("alertWaiting").style.visibility="hidden"}function drawBack(){var e=new Image;e.onload=function(){var t=croquis.getLayerCanvas(activeSlapLayer),a=t.getContext("2d");a.clearRect(0,0,t.width,t.height),a.drawImage(e,0,0),selectLayer(activeSlapLayer)},e.src=activeSlapImg}function saveGesture(){var e=document.getElementById("sendImageForm");addInput(e,"layer_"+activeSlapLayer+"_numgestures",commands.length,"hidden");for(var t=0;t<commands.length;t++){var a="";switch(commands[t].control.bestValue.key){case"r_arrow":a="Gesture{layer:"+activeSlapLayer+"; type:translation; params:[";for(var r=0;r<commands[t].points.length;r++){var o=lookForPoint(scenePoints,commands[t].points[r].bestValue.key);a+=commands[t].points[r].bestValue.key+"("+scenePoints[o].pointObject.x+","+scenePoints[o].pointObject.y+")",r<commands[t].points.length-1&&(a+=" / ")}a+="]}";break;case"r_rotate":a="Gesture{layer:"+activeSlapLayer+"; type:rotation; params:[";for(var r=0;r<commands[t].params.length;r++)a+="s"+r+"("+commands[t].params[r]+")",r<commands[t].points.length-1&&(a+=" / ");a+="]}";break;case"cam":a="Gesture{layer:"+activeSlapLayer+"; type:cam; params:[";for(var r=0;r<commands[t].frames.length;r++)a+="f"+commands[t].frames[r].frameControl+"("+commands[t].frames[r].x+","+commands[t].frames[r].y+","+commands[t].frames[r].width+","+commands[t].frames[r].height+")",r<commands[t].frames.length-1&&(a+=" / ");a+="]}",console.log(a)}addInput(e,"layer_"+activeSlapLayer+"_gesture_"+t,a,"hidden")}contLayers++,console.log(contLayers,gestureLayersNumber),contLayers==gestureLayersNumber&&submitForm(),hideAlert()}function isCanvasBlank(e){var t=document.createElement("canvas");return t.width=e.width,t.height=e.height,e.toDataURL()==t.toDataURL()}function testSlap(e,t,a){activeSlapImg=a,activeSlapLayer=e;var r=new Slap({imageSrc:a,file:"js/slapnet.json",threshold:.7,canvas:t});r.onRecognized=function(){commands=r.getCommands(),scenePoints=r.getScenePoints();if(console.log("COMMANDS",commands),console.log("SCENEPOINTS",scenePoints),0==commands.length)showAlert("Número insuficiente de símbolos para criar um comando.","Tente novamente!","hideAlert()");else for(var t=0;t<commands.length;t++)if(commands[t].error!=r.getError("NO_ERROR"))showAlert(commands[t].error,"Tente novamente!","hideAlert()");else{var a=!0;if(0==commands[t].points.length)a=!0;else for(var o=0;o<commands[t].points.length;o++){commands[t].points[o].bestValue.key;-1==lookForPoint(scenePoints,commands[t].points[o].bestValue.key)&&(a=!1)}var n=commands[t].control.bestValue.key,l="Comando não reconhecido";switch("r_arrow"==n&&(l="translation"),"r_rotate"==n&&(l="rotation"),"cam"==n&&(l="cam"),console.log("===========",l),l){case"translation":if(a){var i="Foi detectada uma <b>"+l+"</b> do ponto <b>"+commands[t].points[0].bestValue.key+"</b> ao ponto <b>"+commands[t].points[1].bestValue.key+"</b>.";showAlert(i,"Está correto?","saveGesture()","hideAlert()")}else{var i="Foi detectada uma <b>translação</b> do ponto <b>"+commands[t].points[0].bestValue.key+"</b> ao ponto <b>"+commands[t].points[1].bestValue.key+"</b>.</p><p> Mas não foram detectados os pontos na cena!</p>";if(console.log(scenePoints),scenePoints.length>0){i+="<p><small>o que foi encontrado: ";for(var t=0;t<scenePoints.length;t++)i+=scenePoints[t].name,t<scenePoints[t].length-1&&(i+=", ")}else i+="<p><small>não foram encontrados todos os pontos!";i+="</small></p>",showAlert(i,"Tente novamente!","hideAlert()")}break;case"rotation":for(var c="",d="",o=0;o<commands[t].points.length;o++){var m=Math.abs(commands[t].timeline.x-commands[t].points[o].x),u=Math.abs(commands[t].timeline.x+commands[t].timeline.width-commands[t].points[o].x);console.log(m,u),u>m?c+=commands[t].points[o].bestValue.key:d+=commands[t].points[o].bestValue.key}commands[t].params=[c,d];var i="Foi detectada uma <b>rotação</b> de <b>"+c+"</b>º para <b>"+d+"º</b>.";showAlert(i,"Está correto?","saveGesture()","hideAlert()");break;case"cam":var y=(r.getObjectVector(),r.getFrames());console.log("FRAMES",y),commands[t].frames=y;var f=!0;if(commands[t].points.length<2){var i="Foi detectado um <b>movimento de câmera</b>. <p>Mas os quadros não foram encontrados na cena!</p>";showAlert(i,"Tente novamente!","hideAlert()")}else{var c=commands[t].points[0],d=commands[t].points[1],i="Foi detectado um <b>movimento de câmera</b> de <b>"+c.bestValue.key+"</b> para <b>"+d.bestValue.key+"</b>.";if(y.length<2)i+="<p> mas não foram encontrados os quadros na cena!</p>";else{var v=lookForFrame(y,c.bestValue.key),p=lookForFrame(y,d.bestValue.key);-1==v&&-1==p||v==p?i+="<p> Mas nenhum quadro foi encontrado!</p>":-1==v?i+="<p> Mas não foi encontrado o quadro <b>"+c.bestValue.key+"</b> na cena!</p>":-1==p?i+="<p> Mas não foi encontrado o quadro <b>"+d.bestValue.key+"</b> na cena!</p>":f=!1,i+="<p><small>Foram encontrados os quadros "+y[0].frameControl+" e "+y[1].frameControl+"</small></p>"}f?showAlert(i,"Tente novamente!","hideAlert()"):showAlert(i,"Está correto?","saveGesture()","hideAlert()")}break;default:var i="O símbolo de controle da <i>timeline</i> não foi encontrado.";showAlert(i,"Tente novamente!","hideAlert()")}}slapResults.push({commands:commands,scenePoints:scenePoints})},r.test()}function lookForFrame(e,t){console.log("LOOK FOR "+t);for(var a=-1,r=0;r<e.length;r++)if(e[r].frameControl==t){a=r;break}return console.log(-1==a?"not found":"found"),a}function lookForPoint(e,t){console.log("LOOK FOR "+t);for(var a=-1,r=0;r<e.length;r++)if(e[r].name==t){a=r;break}return console.log(-1==a?"not found":"found"),a}var cw=640,ch=480,bgcolor="#fff",bcolor="#000",bspacing=.05,bsize=10,blevel=10,bweight=.5,croquis,brushes=[],selectedTool=1,canvasArea,offX,offY,frame_format,ctrl=!1,tools=[],selectedTool=1,alphas=[],layerNames=[],oldColor="#000000",oldAlpha=1,oldSize=10,oldTool=1,selectedLayer=0,contBrushes=0,timer1,timer2,activeTime=0,gestureTime=0,isMoving=!1;const MSG1="As camadas do quadro estão sendo interpretadas. Aguarde!";window.onload=function(){croquis=new Croquis,addBrush(2*bsize,bcolor,.05,"img/brush/brush0.png"),addBrush(bsize/2,bcolor,.1,"img/brush/brush1.png"),addBrush(2*bsize,bcolor,.05,"img/brush/brush3.png"),addBrush(bsize,bcolor,.05,"img/brush/brush0.png")};var gestureLayersNumber=0,contLayers=0,isDragging=!1,slapResults=[],activeSlapLayer=-1,activeSlapImg="",commands=[],scenePoints=[];